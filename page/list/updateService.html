<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.49">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta name="keywords" content="前端一锅煮,serviceWorker 更新方案,阅读器排版引擎,"><link rel="icon" href="/img/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileColor" content="#000000"><title>serviceWorker 更新方案 | 前端一锅煮</title><meta name="description" content="serviceWorker 更新方案">
    <link rel="modulepreload" href="/blog/assets/app.6da7124e.js"><link rel="modulepreload" href="/blog/assets/updateService.html.c0e25538.js"><link rel="modulepreload" href="/blog/assets/updateService.html.e5b5e0fd.js"><link rel="prefetch" href="/blog/assets/index.html.6d01a2cb.js"><link rel="prefetch" href="/blog/assets/index.html.c356b4a5.js"><link rel="prefetch" href="/blog/assets/cola.html.e4806231.js"><link rel="prefetch" href="/blog/assets/quick_app.html.fe111499.js"><link rel="prefetch" href="/blog/assets/webview.html.8973f23c.js"><link rel="prefetch" href="/blog/assets/add.html.6ca15e66.js"><link rel="prefetch" href="/blog/assets/base_summary.html.110ffd64.js"><link rel="prefetch" href="/blog/assets/fn.html.470922ad.js"><link rel="prefetch" href="/blog/assets/promise_all.html.503af5ab.js"><link rel="prefetch" href="/blog/assets/prototype.html.c216cc4e.js"><link rel="prefetch" href="/blog/assets/three.html.c55c611a.js"><link rel="prefetch" href="/blog/assets/bfc.html.12f2f1e5.js"><link rel="prefetch" href="/blog/assets/css_layout_two.html.ba63e39b.js"><link rel="prefetch" href="/blog/assets/ai.html.8d3a8611.js"><link rel="prefetch" href="/blog/assets/index.html.f249b277.js"><link rel="prefetch" href="/blog/assets/aglie.html.f8897adf.js"><link rel="prefetch" href="/blog/assets/app.html.4b9ec687.js"><link rel="prefetch" href="/blog/assets/code_review.html.bc3a99c0.js"><link rel="prefetch" href="/blog/assets/confidence.html.0d77def2.js"><link rel="prefetch" href="/blog/assets/discipline.html.12aa4483.js"><link rel="prefetch" href="/blog/assets/feday.html.43f3a4ee.js"><link rel="prefetch" href="/blog/assets/love.html.2dcaf6fa.js"><link rel="prefetch" href="/blog/assets/money_rate.html.280fa8d1.js"><link rel="prefetch" href="/blog/assets/need_work.html.9fd86d8c.js"><link rel="prefetch" href="/blog/assets/plan.html.55213dc7.js"><link rel="prefetch" href="/blog/assets/soul.html.768e71af.js"><link rel="prefetch" href="/blog/assets/think.html.70b05155.js"><link rel="prefetch" href="/blog/assets/time.html.79f32616.js"><link rel="prefetch" href="/blog/assets/index.html.11af586a.js"><link rel="prefetch" href="/blog/assets/emoji.html.b9989d2d.js"><link rel="prefetch" href="/blog/assets/es6.html.13ed4360.js"><link rel="prefetch" href="/blog/assets/fe.html.3b3d8617.js"><link rel="prefetch" href="/blog/assets/fe_design.html.d5b0b873.js"><link rel="prefetch" href="/blog/assets/fe_server_check.html.4d7b9142.js"><link rel="prefetch" href="/blog/assets/fe_server_name.html.752ce7ca.js"><link rel="prefetch" href="/blog/assets/fe_up.html.29040e77.js"><link rel="prefetch" href="/blog/assets/npm.html.e72aa54c.js"><link rel="prefetch" href="/blog/assets/npm_run.html.98aaa461.js"><link rel="prefetch" href="/blog/assets/project_template.html.288c3dcc.js"><link rel="prefetch" href="/blog/assets/serviceWorker.html.4000b715.js"><link rel="prefetch" href="/blog/assets/sh.html.5f1c0c24.js"><link rel="prefetch" href="/blog/assets/source_link.html.e2fe27e1.js"><link rel="prefetch" href="/blog/assets/sso.html.1d80181a.js"><link rel="prefetch" href="/blog/assets/ts.html.cd7c6443.js"><link rel="prefetch" href="/blog/assets/underline.html.4767bdd2.js"><link rel="prefetch" href="/blog/assets/webpack4.html.ad53dad8.js"><link rel="prefetch" href="/blog/assets/http.html.c0b3835f.js"><link rel="prefetch" href="/blog/assets/loop.html.7ee50776.js"><link rel="prefetch" href="/blog/assets/onion.html.0b6e071f.js"><link rel="prefetch" href="/blog/assets/perf.html.e8293673.js"><link rel="prefetch" href="/blog/assets/power.html.8c0a01bb.js"><link rel="prefetch" href="/blog/assets/process.html.621f9d31.js"><link rel="prefetch" href="/blog/assets/security.html.80097fc7.js"><link rel="prefetch" href="/blog/assets/v8.html.ea1267dc.js"><link rel="prefetch" href="/blog/assets/hb.html.183ccde9.js"><link rel="prefetch" href="/blog/assets/read.html.83444f6d.js"><link rel="prefetch" href="/blog/assets/mac.html.c363b9d0.js"><link rel="prefetch" href="/blog/assets/mac_down.html.4d7a51b5.js"><link rel="prefetch" href="/blog/assets/maclist.html.7fcc92e6.js"><link rel="prefetch" href="/blog/assets/vscode.html.35f0b950.js"><link rel="prefetch" href="/blog/assets/vue_reload.html.50a70fdb.js"><link rel="prefetch" href="/blog/assets/vue_ui_contrast.html.c0f397da.js"><link rel="prefetch" href="/blog/assets/api.html.3ccaacf2.js"><link rel="prefetch" href="/blog/assets/config.html.4b16ab9d.js"><link rel="prefetch" href="/blog/assets/guide.html.f8df3fc6.js"><link rel="prefetch" href="/blog/assets/theme.html.a17dc900.js"><link rel="prefetch" href="/blog/assets/404.html.ab74ef0a.js"><link rel="prefetch" href="/blog/assets/index.html.0888740a.js"><link rel="prefetch" href="/blog/assets/index.html.ccc41012.js"><link rel="prefetch" href="/blog/assets/cola.html.8bdcad90.js"><link rel="prefetch" href="/blog/assets/quick_app.html.369ea008.js"><link rel="prefetch" href="/blog/assets/webview.html.4d28ba0d.js"><link rel="prefetch" href="/blog/assets/add.html.35f80863.js"><link rel="prefetch" href="/blog/assets/base_summary.html.908bfee7.js"><link rel="prefetch" href="/blog/assets/fn.html.ef8c25e1.js"><link rel="prefetch" href="/blog/assets/promise_all.html.7cc3c39b.js"><link rel="prefetch" href="/blog/assets/prototype.html.f3efd717.js"><link rel="prefetch" href="/blog/assets/three.html.62508157.js"><link rel="prefetch" href="/blog/assets/bfc.html.378b7eb8.js"><link rel="prefetch" href="/blog/assets/css_layout_two.html.4236999d.js"><link rel="prefetch" href="/blog/assets/ai.html.e4065256.js"><link rel="prefetch" href="/blog/assets/index.html.e4ef4543.js"><link rel="prefetch" href="/blog/assets/aglie.html.e7dccfaf.js"><link rel="prefetch" href="/blog/assets/app.html.b2b12e5c.js"><link rel="prefetch" href="/blog/assets/code_review.html.2cf45649.js"><link rel="prefetch" href="/blog/assets/confidence.html.44a61c4b.js"><link rel="prefetch" href="/blog/assets/discipline.html.15f00bd9.js"><link rel="prefetch" href="/blog/assets/feday.html.f553c0b8.js"><link rel="prefetch" href="/blog/assets/love.html.3a5a52d3.js"><link rel="prefetch" href="/blog/assets/money_rate.html.b84ac952.js"><link rel="prefetch" href="/blog/assets/need_work.html.f96a41de.js"><link rel="prefetch" href="/blog/assets/plan.html.843657a6.js"><link rel="prefetch" href="/blog/assets/soul.html.cfb53fae.js"><link rel="prefetch" href="/blog/assets/think.html.1c980e83.js"><link rel="prefetch" href="/blog/assets/time.html.ae37d48b.js"><link rel="prefetch" href="/blog/assets/index.html.32c2cb21.js"><link rel="prefetch" href="/blog/assets/emoji.html.9f90cc4b.js"><link rel="prefetch" href="/blog/assets/es6.html.19402800.js"><link rel="prefetch" href="/blog/assets/fe.html.829d0ed8.js"><link rel="prefetch" href="/blog/assets/fe_design.html.0ebf9f0f.js"><link rel="prefetch" href="/blog/assets/fe_server_check.html.4683b7b1.js"><link rel="prefetch" href="/blog/assets/fe_server_name.html.4509d936.js"><link rel="prefetch" href="/blog/assets/fe_up.html.dbd34ebc.js"><link rel="prefetch" href="/blog/assets/npm.html.18fcb0c1.js"><link rel="prefetch" href="/blog/assets/npm_run.html.e7bf9355.js"><link rel="prefetch" href="/blog/assets/project_template.html.9d409a08.js"><link rel="prefetch" href="/blog/assets/serviceWorker.html.c831498e.js"><link rel="prefetch" href="/blog/assets/sh.html.3eac8d25.js"><link rel="prefetch" href="/blog/assets/source_link.html.ddd0787b.js"><link rel="prefetch" href="/blog/assets/sso.html.1c880d53.js"><link rel="prefetch" href="/blog/assets/ts.html.14acd559.js"><link rel="prefetch" href="/blog/assets/underline.html.89d47386.js"><link rel="prefetch" href="/blog/assets/webpack4.html.fbb2a1be.js"><link rel="prefetch" href="/blog/assets/http.html.bade9cd1.js"><link rel="prefetch" href="/blog/assets/loop.html.6be584fc.js"><link rel="prefetch" href="/blog/assets/onion.html.7057f780.js"><link rel="prefetch" href="/blog/assets/perf.html.c6e11b1b.js"><link rel="prefetch" href="/blog/assets/power.html.600609ae.js"><link rel="prefetch" href="/blog/assets/process.html.ce6edbf4.js"><link rel="prefetch" href="/blog/assets/security.html.d44ee077.js"><link rel="prefetch" href="/blog/assets/v8.html.a2ea5e36.js"><link rel="prefetch" href="/blog/assets/hb.html.a487989f.js"><link rel="prefetch" href="/blog/assets/read.html.69d44037.js"><link rel="prefetch" href="/blog/assets/mac.html.66f12713.js"><link rel="prefetch" href="/blog/assets/mac_down.html.cf3721e9.js"><link rel="prefetch" href="/blog/assets/maclist.html.282230ed.js"><link rel="prefetch" href="/blog/assets/vscode.html.a96c48ed.js"><link rel="prefetch" href="/blog/assets/vue_reload.html.79fd663c.js"><link rel="prefetch" href="/blog/assets/vue_ui_contrast.html.44daba36.js"><link rel="prefetch" href="/blog/assets/api.html.f52ab485.js"><link rel="prefetch" href="/blog/assets/config.html.5ee8988d.js"><link rel="prefetch" href="/blog/assets/guide.html.7d6e4938.js"><link rel="prefetch" href="/blog/assets/theme.html.ada8587b.js"><link rel="prefetch" href="/blog/assets/404.html.fa4ec67a.js"><link rel="prefetch" href="/blog/assets/404.389b8e98.js"><link rel="prefetch" href="/blog/assets/Layout.bbf94219.js"><link rel="prefetch" href="/blog/assets/vEmoji.f4f2da1c.js"><link rel="prefetch" href="/blog/assets/vHome.915a7d14.js"><link rel="prefetch" href="/blog/assets/vLife.c0039bb2.js"><link rel="prefetch" href="/blog/assets/vList.efc7a95f.js"><link rel="prefetch" href="/blog/assets/index.0e8935cb.js">
    <link rel="stylesheet" href="/blog/assets/style.04020ca0.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><!----><span class="site-name can-hide">前端一锅煮</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/page/list/" class="router-link-active" aria-label="技术文章"><!--[--><!--]--> 技术文章 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/page/life/" class="" aria-label="生活感悟"><!--[--><!--]--> 生活感悟 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/page/about/" class="" aria-label="关于我"><!--[--><!--]--> 关于我 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="VuePress笔记"><span class="title">VuePress笔记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="VuePress笔记"><span class="title">VuePress笔记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/guide" class="" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/api" class="" aria-label="语法"><!--[--><!--]--> 语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/config" class="" aria-label="配置"><!--[--><!--]--> 配置 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/theme" class="" aria-label="主题"><!--[--><!--]--> 主题 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/cjm0/blog.git" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/page/list/" class="router-link-active" aria-label="技术文章"><!--[--><!--]--> 技术文章 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/page/life/" class="" aria-label="生活感悟"><!--[--><!--]--> 生活感悟 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/page/about/" class="" aria-label="关于我"><!--[--><!--]--> 关于我 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="VuePress笔记"><span class="title">VuePress笔记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="VuePress笔记"><span class="title">VuePress笔记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/guide" class="" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/api" class="" aria-label="语法"><!--[--><!--]--> 语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/config" class="" aria-label="配置"><!--[--><!--]--> 配置 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/page/vuepress/theme" class="" aria-label="主题"><!--[--><!--]--> 主题 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/cjm0/blog.git" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">serviceWorker 更新方案 <!----></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/page/list/updateService.html#为什么加-serviceworker-缓存" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么加 serviceWorker 缓存"><!--[--><!--]--> 为什么加 serviceWorker 缓存 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#加缓存后引发的问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="加缓存后引发的问题"><!--[--><!--]--> 加缓存后引发的问题 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#探索强制更新方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="探索强制更新方案"><!--[--><!--]--> 探索强制更新方案 <!--[--><!--]--></a><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/page/list/updateService.html#方案1-文件变更" class="router-link-active router-link-exact-active sidebar-item" aria-label="方案1-文件变更"><!--[--><!--]--> 方案1-文件变更 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#方案2-监听更新事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="方案2-监听更新事件"><!--[--><!--]--> 方案2-监听更新事件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#方案3-自动刷页面" class="router-link-active router-link-exact-active sidebar-item" aria-label="方案3-自动刷页面"><!--[--><!--]--> 方案3-自动刷页面 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#方案4-配置文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="方案4-配置文件"><!--[--><!--]--> 方案4-配置文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#方案5-url标识" class="router-link-active router-link-exact-active sidebar-item" aria-label="方案5-URL标识"><!--[--><!--]--> 方案5-URL标识 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/blog/page/list/updateService.html#实现细节" class="router-link-active router-link-exact-active sidebar-item" aria-label="实现细节"><!--[--><!--]--> 实现细节 <!--[--><!--]--></a><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/page/list/updateService.html#实现逻辑" class="router-link-active router-link-exact-active sidebar-item" aria-label="实现逻辑"><!--[--><!--]--> 实现逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#具体操作" class="router-link-active router-link-exact-active sidebar-item" aria-label="具体操作"><!--[--><!--]--> 具体操作 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/page/list/updateService.html#注意事项" class="router-link-active router-link-exact-active sidebar-item" aria-label="注意事项"><!--[--><!--]--> 注意事项 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="serviceworker-更新方案" tabindex="-1"><a class="header-anchor" href="#serviceworker-更新方案" aria-hidden="true">#</a> serviceWorker 更新方案</h1><p>目录</p><ul><li><p>为什么加 serviceWorker 缓存</p></li><li><p>加缓存后引发的问题</p></li><li><p>探索强制更新方案</p></li><li><p>实现细节</p></li></ul><h2 id="为什么加-serviceworker-缓存" tabindex="-1"><a class="header-anchor" href="#为什么加-serviceworker-缓存" aria-hidden="true">#</a> 为什么加 serviceWorker 缓存</h2><p>serviceWorker 具体用法可参考文章 <a href="https://cjm0.github.io/blog/page/list/serviceWorker.html" target="_blank" rel="noopener noreferrer">serviceWorker 实战<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>下面通过几张图的对比来看下加缓存后的具体效果：</p><p>深圳请求广州服务器，请求<strong>距离近，不加缓存 51ms</strong></p><p><img src="https://pic1.zhimg.com/80/v2-d32f24770e6ad31f70c3d17430ac0904_1440w.webp" alt="1.png"></p><p>深圳请求广州服务器，请求<strong>距离近，加缓存后 27ms</strong></p><p><img src="https://pic4.zhimg.com/80/v2-c4348712f8cce71bff219189058ef0d3_1440w.webp" alt="2.png"></p><p>深圳请求南京服务器，请求<strong>距离远，不加缓存 106ms</strong></p><p><img src="https://pic2.zhimg.com/80/v2-6e61b85f21890360633ae083876e8315_1440w.webp" alt="3.png"></p><p>深圳请求南京服务器，请求<strong>距离远，加缓存后 44ms</strong></p><p><img src="https://pic4.zhimg.com/80/v2-b083c00da593a4669893725b1323f9ff_1440w.webp" alt="4.png"></p><p>用 3G 网络，<strong>不加缓存 594ms</strong></p><p><img src="https://pic1.zhimg.com/80/v2-7480cecfb06c9388f067c65ee94e4290_1440w.webp" alt="5.png"></p><p>用 3G 网络，<strong>加缓存后 26ms</strong></p><p><img src="https://pic4.zhimg.com/80/v2-4bba8eaca1c6470b867f45cdbddf948b_1440w.webp" alt="6.png"></p><p>对比后发现：</p><ol><li><p>不加缓存：html 请求时间，与服务器距离和网速有关，距离越远、网络越差耗时越多，在 50ms~600ms+</p></li><li><p>加缓存：html 请求时间，与服务器距离和网速有无关，稳定在 50ms 以内</p></li></ol><p>结论：</p><p><strong>加 serviceWorker 缓存可确保各地用户在网络不好的时候都能快速拿到 html</strong></p><h2 id="加缓存后引发的问题" tabindex="-1"><a class="header-anchor" href="#加缓存后引发的问题" aria-hidden="true">#</a> 加缓存后引发的问题</h2><h4 id="缓存更新策略" tabindex="-1"><a class="header-anchor" href="#缓存更新策略" aria-hidden="true">#</a> 缓存更新策略：</h4><p>用户进入网页，没有缓存，通过网络请求 html，拿到结果后加入缓存</p><p>用户进入网页，有缓存后，<strong>先读取缓存的 html 去渲染执行</strong>，然后请求新的 html 去更新缓存</p><p>通过下面两张图来看下 serviceWorker 具体的更新机制：</p><p><img src="https://pic2.zhimg.com/80/v2-6e8ebd4a538fedc1f94a36217278a041_1440w.webp" alt="7.png"></p><p><img src="https://pic4.zhimg.com/80/v2-52bbead3315e2a9f960510265d60cc37_1440w.webp" alt="8.png"></p><h4 id="存在的问题" tabindex="-1"><a class="header-anchor" href="#存在的问题" aria-hidden="true">#</a> 存在的问题：</h4><p><strong>用户需要进 2 次网页才能看到最新的版本功能</strong></p><h2 id="探索强制更新方案" tabindex="-1"><a class="header-anchor" href="#探索强制更新方案" aria-hidden="true">#</a> 探索强制更新方案</h2><p>如何实现按需更新网页？探索了以下几个方案：</p><h3 id="方案1-文件变更" tabindex="-1"><a class="header-anchor" href="#方案1-文件变更" aria-hidden="true">#</a> 方案1-文件变更</h3><p>最开始想到的方法：</p><p>发版的时候更新 serviceWorker.js 里面的版本号引起文件的变更从而使 serviceWorker 重新安装激活</p><p><img src="https://pic4.zhimg.com/80/v2-a110133c94f8bcae2a604d37b9c34a8b_1440w.webp" alt="9.png"></p><p>执行顺序：fetch 请求 html =&gt; serviceWorker.register() =&gt; 发现变更重新安装激活</p><p><strong>结论：方案行不通，html 的请求是最早的，而 serviceWorker 的注册、安装、激活更滞后</strong></p><h3 id="方案2-监听更新事件" tabindex="-1"><a class="header-anchor" href="#方案2-监听更新事件" aria-hidden="true">#</a> 方案2-监听更新事件</h3><p>监听 serviceWorker 的更新事件：</p><ol><li><p>当 ServiceWorker installing 属性获取新的服务工作线程时，会触发 updatefound 事件</p></li><li><p>更新 serviceWorker.js 里面的版本号，引发重新安装激活，同时监听 updatefound 事件</p></li><li><p>发现有更新就出提示弹框，用户点击后，强制刷新浏览器更新</p></li></ol><p><strong>结论：方案可行，但是用户体验不好，用户需要手动点击强制刷新</strong></p><h3 id="方案3-自动刷页面" tabindex="-1"><a class="header-anchor" href="#方案3-自动刷页面" aria-hidden="true">#</a> 方案3-自动刷页面</h3><p>偷偷刷新页面：</p><p>用户进入页面后，出 loading，自动去刷新 1 次页面</p><p>可以前端自己强刷 1 次</p><p>内嵌在客户端的可以让客户端容器强刷 1 次</p><p><strong>结论：体验不好</strong></p><h3 id="方案4-配置文件" tabindex="-1"><a class="header-anchor" href="#方案4-配置文件" aria-hidden="true">#</a> 方案4-配置文件</h3><p>在 fetch 里做拦截，比较远程配置：</p><p><img src="https://pic1.zhimg.com/80/v2-cdceeea26006c5f61add51edbb4b32e8_1440w.webp" alt="10.png"></p><p>fetch 拦截时机最早，拦截 html 请求的时候，先去请求1个远程配置文件</p><p>然后比较配置文件里的版本号和缓存的版本号，一致走缓存，不一致走网络请求</p><p>请求远程配置文件会有一定耗时，耗时过久会抵消缓存产生的效益</p><p><strong>结论：方案可行，需要控制住配置文件请求耗时</strong></p><h3 id="方案5-url标识" tabindex="-1"><a class="header-anchor" href="#方案5-url标识" aria-hidden="true">#</a> 方案5-URL标识</h3><p>在 fetch 里做拦截，比较 url：</p><p><img src="https://pic4.zhimg.com/80/v2-d4db3dd444115c96716827c7f12ccc67_1440w.webp" alt="11.png"></p><p>fetch 拦截时机最早</p><p>需要强制刷新的时候，修改访问链接 url 携带的标识字段值</p><p>fetch 拦截 html 请求的时候，通过比较 url 标识和缓存标识，一致走缓存，不一致走网络请求</p><p>需要具备变更 url 的条件（比如由内嵌容器控制入口和变更）</p><p><strong>结论：方案可行，需要 url 具备可变更条件</strong></p><h2 id="实现细节" tabindex="-1"><a class="header-anchor" href="#实现细节" aria-hidden="true">#</a> 实现细节</h2><p>因为项目内嵌在客户端容器里，支持动态拼接修改 url，所以用的是方案5</p><p>下面看下具体实现：</p><h3 id="实现逻辑" tabindex="-1"><a class="header-anchor" href="#实现逻辑" aria-hidden="true">#</a> 实现逻辑</h3><ol><li><p>网站核心入口是 html，资源类型为 document</p></li><li><p>客户端控制在跳对应网站的时候，url 上拼接 readerVersion=new1</p></li><li><p>serviceWorker fetch 拦截 html，判断缓存的 readerVersion 值和 url 上的值是否一致：</p></li></ol><ul><li><p>一致，走本地缓存，同时更新 serviceWorker 的缓存</p></li><li><p>不一致，走网络请求，请求成功后更新 serviceWorker 的缓存</p></li><li><p>网络请求失败走 serviceWorker 的旧缓存兜底</p></li></ul><h3 id="具体操作" tabindex="-1"><a class="header-anchor" href="#具体操作" aria-hidden="true">#</a> 具体操作</h3><ol><li><p>前端代码发布上线，此时 readerVersion =&gt; &#39;&#39;</p></li><li><p>配置平台修改 readerVersion =&gt; new1+</p></li><li><p>上线完毕，看数据大部分用户更新后，可恢复配置 readerVersion =&gt; &#39;&#39;，也可不恢复</p></li></ol><h3 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项" aria-hidden="true">#</a> 注意事项</h3><ol><li><p>强制更新客户端 readerVersion=new1 每次需要加 1，new1 =&gt; new2</p></li><li><p>fetch 拦截 html 请求需要排除 favicon.ico，服务器会自动请求此图标链接，同样返回 html</p></li></ol><p><img src="https://pic4.zhimg.com/80/v2-acc28e3563e1a1ad90289f7fd10cd9e7_1440w.webp" alt="13.png"></p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/cjm0/blog.git/edit/master/docs/page/list/updateService.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/blog/assets/app.6da7124e.js" defer></script>
  </body>
</html>
